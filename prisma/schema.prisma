generator client {
  provider   = "prisma-client"                  // <- new client generator
  output     = "../lib/generated/prisma-client" // <- keep output under lib
  engineType = "client"                         // <- Rust-free architecture
}

datasource db {
  provider  = "postgresql"
}

model Customer {
  id                      String         @id @default(cuid())
  firstName               String
  lastName                String
  email                   String         @unique
  phone                   String
  passwordHash            String?
  deliveryAddress         String?
  billingAddress          String?
  country                 String?
  state                   String?
  registeredAt            DateTime       @default(now())
  lastLogin               DateTime?
  emailVerified           Boolean        @default(false)
  verificationToken       String?
  verificationTokenExpiry DateTime?
  resetToken              String?
  resetTokenExpiry        DateTime?
  orders                  Order[]
  reviews                 Review[]
  wishlistItems           WishlistItem[]
}

model Staff {
  id                String        @id @default(cuid())
  firstName         String
  middleName        String?       @default("")
  lastName          String
  email             String        @unique
  phone             String
  passwordHash      String
  jobRoles          JobRole[]     @default([])
  access            UserRole
  createdAt         DateTime      @default(now())
  emailVerified     Boolean       @default(true)
  dateOfBirth       DateTime?
  dateOfEmployment  DateTime?     @default(now())
  dateOfResignation DateTime?
  address           String?
  emailPersonal     String?
  guarantorName     String?
  guarantorAddress  String?
  guarantorPhone    String?
  resetToken        String?
  resetTokenExpiry  String?
  lastLogin         DateTime?
  offlineSales      OfflineSale[]
  orders            Order[]
}

model Category {
  slug        String    @id
  name        String
  description String?
  bannerImage String?
  isActive    Boolean   @default(true)
  sortOrder   Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  products    Product[] @relation("ProductToCategory")

  @@index([isActive, sortOrder])
  @@index([name])
}

model Product {
  id            String         @id @default(cuid())
  name          String
  description   String?
  images        String[]       @default([])
  categorySlug  String
  priceNGN      Float?
  priceUSD      Float?
  priceEUR      Float?
  priceGBP      Float?
  sizeMods      Boolean        @default(false)
  status        ProductStatus  @default(Draft)
  videoUrl      String?
  averageRating Float          @default(0)
  ratingCount   Int            @default(0)
  createdAt     DateTime       @default(now())
  category      Category       @relation("ProductToCategory", fields: [categorySlug], references: [slug])
  reviews       Review[]
  variants      Variant[]
  wishlistItems WishlistItem[]

  @@index([categorySlug])
  @@index([status, createdAt])
}

model Variant {
  id         String      @id @default(cuid())
  productId  String
  color      String
  size       String
  stock      Int
  weight     Float?
  createdAt  DateTime    @default(now())
  orderItems OrderItem[]
  product    Product     @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, color, size], name: "product_color_size")
  @@index([productId])
}

model Review {
  id         String   @id @default(cuid())
  productId  String
  customerId String
  rating     Int
  body       String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, customerId], name: "product_customer_unique_review")
  @@index([productId])
  @@index([customerId])
  @@index([rating])
}

/// *
///  * Only courier options exist (no pickup).
///  * - FIXED: charge baseFee (optionally in baseCurrency).
///  * - EXTERNAL: fetch from provider (DHL/FedEx/etc) at checkout.
model DeliveryOption {
  id           String              @id @default(cuid())
  name         String
  provider     String?
  pricingMode  DeliveryPricingMode @default(FIXED)
  baseFee      Float?
  baseCurrency Currency?
  active       Boolean             @default(true)
  metadata     Json?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  orders       Order[]             @relation("OrderDeliveryOption")

  @@index([active, pricingMode])
  @@index([provider])
}

model Order {
  id                  String              @id @default(uuid())
  status              OrderStatus         @default(Processing)
  currency            Currency
  totalAmount         Float
  totalNGN            Int
  paymentMethod       String
  paymentReference    String?             @unique
  paymentProviderId   String?
  paymentVerified     Boolean             @default(false)
  createdAt           DateTime            @default(now())
  customerId          String?
  guestInfo           Json?
  staffId             String?
  channel             OrderChannel        @default(ONLINE)
  deliveryOptionId    String?
  deliveryFee         Float?
  deliveryDetails     Json?
  refundedAt          DateTime?
  refundReason        String?
  refundTransactionId String?
  refundStatus        RefundStatus?
  offlineSale         OfflineSale?
  customer            Customer?           @relation(fields: [customerId], references: [id])
  deliveryOption      DeliveryOption?     @relation("OrderDeliveryOption", fields: [deliveryOptionId], references: [id])
  staff               Staff?              @relation(fields: [staffId], references: [id])
  items               OrderItem[]
  receiptEmailStatus  ReceiptEmailStatus?

  @@index([createdAt])
  @@index([status, createdAt])
}

model OrderItem {
  id         String   @id @default(cuid())
  orderId    String
  variantId  String
  name       String
  image      String?
  category   String
  quantity   Int
  currency   Currency
  lineTotal  Float
  color      String
  size       String
  hasSizeMod Boolean  @default(false)
  sizeModFee Float    @default(0)
  customSize Json?
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variant    Variant  @relation(fields: [variantId], references: [id])
}

model OfflineSale {
  id        String   @id @default(uuid())
  orderId   String   @unique
  staffId   String
  timestamp DateTime @default(now())
  order     Order    @relation(fields: [orderId], references: [id])
  staff     Staff    @relation(fields: [staffId], references: [id])
}

model WishlistItem {
  id         String   @id @default(cuid())
  customerId String
  productId  String
  addedAt    DateTime @default(now())
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([customerId, productId])
}

model ReceiptEmailStatus {
  orderId     String    @id
  attempts    Int       @default(0)
  lastError   String?
  nextRetryAt DateTime?
  sent        Boolean   @default(false)
  deliveryFee Float?
  updatedAt   DateTime  @updatedAt
  order       Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

model WebhookEvent {
  id        String   @id @default(cuid())
  provider  String
  eventId   String   @unique
  payload   Json
  createdAt DateTime @default(now())
}

model OrphanPayment {
  id             String    @id @default(cuid())
  reference      String    @unique
  amount         Int
  currency       String
  payload        Json
  firstSeenAt    DateTime  @default(now())
  reconciled     Boolean   @default(false)
  reconciledAt   DateTime?
  resolutionNote String?
}

/// * Homepage hero
model HeroSlide {
  id          String  @id @default(cuid())
  imageUrl    String
  headline    String?
  subheadline String?
  ctaText     String?
  ctaUrl      String?
  order       Int     @default(0)
}

model SizeChart {
  id        String         @id @default(cuid())
  name      String
  updatedAt DateTime       @updatedAt
  rows      SizeChartRow[]  // <— clean relation name
}

model SizeChartRow {
  id          String    @id @default(cuid())
  order       Int       @default(0)
  bodySize    String
  productSize String
  code        String

  chart    SizeChart @relation(fields: [chartId], references: [id], onDelete: Cascade)
  chartId  String

  @@index([chartId, order])
}

/// ─────────────────────────── Enums ───────────────────────────
enum ProductStatus {
  Draft
  Published
  Archived
}

enum OrderStatus {
  Processing
  Shipped
  Delivered
  Cancelled
}

enum Currency {
  NGN
  USD
  EUR
  GBP
}

enum OrderChannel {
  ONLINE
  OFFLINE
}

enum JobRole {
  SystemAdministrator
  DispatchCoordinator
  OrderProcessingSpecialist
  ProductCatalogManager
  CustomerSupportRep
}

enum UserRole {
  SuperAdmin
  ProductAdmin
  OrderAdmin
  DispatchUser
  SupportUser
}

enum RefundStatus {
  Pending
  Completed
  Failed
}

/// * How delivery is priced
enum DeliveryPricingMode {
  FIXED
  EXTERNAL
}

model ProductSerial {
  id BigInt @id @default(autoincrement())
}

model OrderSerial {
  id        BigInt   @id @default(autoincrement())
}